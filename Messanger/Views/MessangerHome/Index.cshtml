@model Messanger.Models.ViewModels.HomePageViewModel
@using System.Text.Encodings.Web
@using System.Text.RegularExpressions

@{
    ViewData["Title"] = "Месенджер";
    int? currentChatId = Model.SelectedChatId;
}
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"]</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href = "~/css/MessangerHomeStyle.css" />

</head>
<body class="d-flex" style="height:100%">
    <div class="d-flex flex-column profile">
        <div class="text-center mb-4">
            @if (!string.IsNullOrEmpty(Model.CurrentUserAva))
            {
                <img src="@Model.CurrentUserAva" class="avatar mb-2" />
            }
            <h5>@Model.CurrentUserLogin</h5>
            <small class="text-muted">@Model.CurrentUserEmail</small>
        </div>
        <h6>Чати</h6>
        <ul class="list-group chat-list">
            @foreach (var c in Model.Chats)
            {
                var active = c.UserId == currentChatId ? "active" : "";
                <li class="list-group-item @active p-2">
                    <a asp-action="Index" asp-route-chatId="@c.UserId" class="d-flex justify-content-between text-decoration-none text-dark">
                        <span>@c.Login</span>
                        <small class="text-muted">@c.LastAt.ToLocalTime():HH:mm</small>
                    </a>
                </li>
            }
        </ul>
        <input id="userSearch" class="form-control mb-2" placeholder="Пошук за логіном або email" />
        <ul id="searchResults" class="list-group mb-3"></ul>
    </div>

    <div class="d-flex flex-column flex-grow-1 chat-container p-3 bg-light">
        @if (!currentChatId.HasValue)
        {
            <div class="d-flex flex-grow-1 justify-content-center align-items-center">
                <span class="text-muted">Оберіть чат ліворуч або використайте пошук</span>
            </div>
        }
        else
        {
            <div class="mb-3">
                @{
                    var partner = Model.Chats.FirstOrDefault(c => c.UserId == currentChatId)?.Login;
                }
                <h5>Чат з @partner</h5>
            </div>
            <div id="messages" class="messages mb-3">
                @foreach (var m in Model.Messages)
                {
                    var isOwnMessage = m.UserLogin == Model.CurrentUserLogin;
                    var encoded = HtmlEncoder.Default.Encode(m.Text);
                    var linked = Regex.Replace(encoded, @"(https?://[^\s]+)", @"<a href=""$1"" target=""_blank"">$1</a>");

                    <div class="message-wrapper @(isOwnMessage ? "justify-content-end" : "justify-content-start")">
                        @if (!isOwnMessage)
                        {
                            <img src="@m.UserAvatar" class="avatar" />
                        }
                        <div class="message @(isOwnMessage ? "message-right" : "message-left")">
                            @Html.Raw(linked.Replace("\n", "<br/>"))
                            <div class="message-time">@m.CreatedAt.ToLocalTime():HH:mm</div>
                        </div>
                        @if (isOwnMessage)
                        {
                            <img src="@Model.CurrentUserAva" class="avatar" />
                        }
                    </div>
                }
            </div>

            <div class="input-area">
                <input type="file" id="fileInput" class="form-control" />
                <button id="sendFileBtn" class="btn btn-secondary">📎</button>
                <form asp-action="Index" method="post" asp-route-chatId="@currentChatId" class="flex-grow-1 d-flex ms-2">
                    <input name="text" class="form-control me-2" placeholder="Написати..." autocomplete="off" />
                    <button class="btn btn-primary">▶️</button>
                </form>
            </div>
        }
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@7.0.0/dist/browser/signalr.min.js"></script>
    <script>
        window.chatConfig = {
            currentUserId: '@Model.CurrentUserId',
            currentUserLogin: '@Model.CurrentUserLogin',
            currentUserAva: '@Model.CurrentUserAva',
            currentChatId: @(currentChatId.HasValue ? currentChatId.Value.ToString() : "null")
        };
    </script>
    <script src="~/js/chat.js"></script>

</body>
</html>

